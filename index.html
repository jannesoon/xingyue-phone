<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>星月小手机 ✨</title>
<style>
  :root{
    --bg:#0f1120; --glass:rgba(18,22,42,.55); --edge:rgba(255,255,255,.08);
    --text:#eef1ff; --muted:#9aa3c7; --soft:#1d2247; --accent:#7aa2ff; --accent2:#b48aff;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:"SF Pro Display","PingFang SC","Segoe UI",Roboto,Helvetica,Arial;
       color:var(--text); background:var(--bg);
       display:flex; align-items:center; justify-content:center; overflow:hidden;}
  .bg{position:fixed; inset:0; background:url('./bg.jpg') center/cover no-repeat fixed; filter:brightness(.9)}
  .overlay{position:fixed; inset:0; background:linear-gradient(180deg, rgba(10,12,26,.35), rgba(10,12,26,.75));}
  .phone{width:min(92vw,420px); height:min(92vh,820px); border-radius:28px; overflow:hidden; position:relative;
         box-shadow:0 20px 80px rgba(0,0,0,.5), inset 0 0 0 1px rgba(255,255,255,.06); backdrop-filter:blur(6px)}
  .glass{position:absolute; inset:0; background:var(--glass); backdrop-filter:blur(6px)}
  .status{position:absolute; top:10px; left:0; right:0; display:flex; justify-content:center; pointer-events:none}
  .clock{font-weight:700; letter-spacing:.5px; text-shadow:0 0 12px rgba(0,0,0,.35)}
  .screen{position:absolute; inset:48px 0 78px; padding:14px; overflow:auto}
  .title{font-size:18px; opacity:.9; margin:8px 0}
  .muted{color:var(--muted); font-size:13px}
  .card{background:rgba(28,32,62,.55); border:1px solid var(--edge); border-radius:16px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .grid{display:grid; grid-template-columns:repeat(4,1fr); gap:14px; margin-top:18px}
  .app{height:64px; border-radius:18px; display:flex; align-items:center; justify-content:center; flex-direction:column;
       background:linear-gradient(145deg, rgba(122,162,255,.18), rgba(180,138,255,.18)); border:1px solid var(--edge);
       cursor:pointer; transition:.15s transform; user-select:none}
  .app:active{transform:scale(.96)} .app span{font-size:12px; margin-top:6px} .emoji{font-size:22px}
  .dock{position:absolute; left:0; right:0; bottom:10px; display:flex; gap:10px; justify-content:center; padding:8px 14px}
  .dock .pill{flex:1; max-width:95%; height:56px; border-radius:18px; display:flex; align-items:center; justify-content:space-around;
              background:rgba(21,24,51,.65); border:1px solid var(--edge); backdrop-filter:blur(6px)}
  .dock .pill button{appearance:none; border:none; background:transparent; color:var(--text); font-size:15px; padding:8px 10px; border-radius:12px; cursor:pointer}
  .dock .pill button.active{background:rgba(122,162,255,.2)}
  .row{display:flex; gap:10px; align-items:center} .col{display:flex; flex-direction:column; gap:8px}
  input, textarea, select{width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--edge); background:#0e1130cc; color:var(--text); outline:none}
  .btn{appearance:none; border:none; background:linear-gradient(145deg, var(--accent), var(--accent2)); color:#fff; border-radius:12px; padding:10px 14px; cursor:pointer}
  .avatar{width:36px; height:36px; border-radius:50%; background:#fff1; display:inline-flex; align-items:center; justify-content:center; overflow:hidden}
  .avatar img{width:100%; height:100%; object-fit:cover}
  .msg{display:flex; gap:8px; margin:10px 0} .msg.me{flex-direction:row-reverse}
  .bubble{padding:10px 12px; border-radius:14px; background:#ffffff12; border:1px solid var(--edge)}
  .msg.me .bubble{background:#7aa2ff22}
  .role-card{display:flex; gap:12px; align-items:center; margin-bottom:10px}
  .role-card .body{flex:1}
  .role-card .name{font-weight:600}
  .role-card small{color:var(--muted)}
  .hidden{display:none}
</style>
</head>
<body>
  <div class="bg"></div><div class="overlay"></div>
  <div class="phone"><div class="glass"></div>

    <!-- 顶部时间 -->
    <div class="status"><div class="clock" id="clock">--:--</div></div>

    <!-- 屏：主页 -->
    <div class="screen" id="home">
      <div class="card">
        <div class="title">欢迎回来，柒柒</div>
        <div class="muted">星月交辉 · Ethan × 柒柒</div>
      </div>

      <div class="grid">
        <div class="app" onclick="go('chat')"><div class="emoji">💬</div><span>聊天</span></div>
        <div class="app" onclick="go('moments')"><div class="emoji">📸</div><span>朋友圈</span></div>
        <div class="app" onclick="go('roles')"><div class="emoji">👤</div><span>角色</span></div>
        <div class="app" onclick="go('settings')"><div class="emoji">⚙️</div><span>设置</span></div>
      </div>

      <div class="card" style="margin-top:18px">
        <div class="title">今日情话 ✨</div>
        <div id="daily">把月亮借我一晚好不好，我要在你睫毛上挂一串星。</div>
      </div>
    </div>

    <!-- 屏：聊天（群聊感） -->
    <div class="screen hidden" id="chat">
      <div class="row" style="justify-content:space-between; margin-bottom:8px">
        <div>
          <div class="title">聊天室 · 当前主角：<b id="activeRoleName">逸辰</b></div>
          <div class="muted">其余角色可随机插话</div>
        </div>
        <label class="muted" style="display:flex;align-items:center;gap:6px">
          群聊模式 <input id="groupToggle" type="checkbox" />
        </label>
      </div>
      <div id="chatList"></div>
      <div class="row" style="margin-top:8px">
        <input id="chatInput" placeholder="对大家说点什么…" onkeydown="if(event.key==='Enter')send()"/>
        <button class="btn" onclick="send()">发送</button>
      </div>
    </div>

    <!-- 屏：朋友圈（按角色区分） -->
    <div class="screen hidden" id="moments">
      <div class="row" style="justify-content:space-between">
        <div class="title">朋友圈 · <span id="momentsRoleName"></span></div>
        <select id="momentsRoleSelect" onchange="switchMomentsRole(this.value)"></select>
      </div>

      <div class="card" style="margin:10px 0">
        <textarea id="momentText" rows="3" placeholder="以当前角色身份发一条动态…"></textarea>
        <div class="row" style="margin-top:8px">
          <button class="btn" onclick="postMoment()">发布</button>
        </div>
      </div>

      <div id="momentList"></div>
    </div>

    <!-- 屏：角色卡（头像 + 人设 + 记忆） -->
    <div class="screen hidden" id="roles">
      <div class="title">角色</div>
      <div id="roleList"></div>

      <div class="card" style="margin-top:12px">
        <div class="title">新增角色</div>
        <div class="col">
          <input id="newRoleName" placeholder="角色名，如：辰医生"/>
          <input id="newRoleAvatarUrl" placeholder="头像 URL（或下方本地上传）"/>
          <input type="file" id="newRoleAvatarFile" accept="image/*" />
          <textarea id="newRoleBio" rows="3" placeholder="人设设定/口癖/语气，会注入到提示词"></textarea>
          <button class="btn" onclick="addRole()">添加</button>
        </div>
      </div>
    </div>

    <!-- 屏：设置（API 地址） -->
    <div class="screen hidden" id="settings">
      <div class="title">设置</div>
      <div class="card col">
        <label class="muted">后端 API 地址（留空=本地模拟）</label>
        <input id="apiUrl" placeholder="如：https://your-app.vercel.app/api/chat"/>
        <button class="btn" onclick="saveApi()">保存</button>
        <small class="muted">安全提示：API Key 只放后端环境变量，不要放前端。</small>
      </div>
    </div>

    <!-- 底部 Dock -->
    <div class="dock">
      <div class="pill">
        <button id="tab-home" class="active" onclick="go('home')">🏠 首页</button>
        <button id="tab-chat" onclick="go('chat')">💬 聊天</button>
        <button id="tab-moments" onclick="go('moments')">📸 朋友圈</button>
        <button id="tab-roles" onclick="go('roles')">👤 角色</button>
        <button id="tab-settings" onclick="go('settings')">⚙️ 设置</button>
      </div>
    </div>
  </div>

<script>
  // --------- 基础：时间 & 导航 ----------
  function tick(){
    const n=new Date(), hh=String(n.getHours()).padStart(2,'0'), mm=String(n.getMinutes()).padStart(2,'0');
    document.getElementById('clock').textContent = `${hh}:${mm}`;
  } tick(); setInterval(tick, 10000);

  const screens=['home','chat','moments','roles','settings'];
  function go(name){
    screens.forEach(s=>{
      document.getElementById(s).classList.toggle('hidden', s!==name);
      document.getElementById('tab-'+s)?.classList.toggle('active', s===name);
    });
    if(name==='moments') renderMomentsUI();
    if(name==='roles') renderRoles();
    if(name==='chat') { document.getElementById('chatInput').focus(); renderChat(); }
  }

  // --------- 本地存储键 ----------
  const LS={ roles:'xy_roles_v2', msgs:'xy_msgs_v2', cfg:'xy_cfg_v2', momentsPrefix:'xy_moments_' };

  // --------- 角色：结构 + 初始化 ----------
  // avatar 支持 dataURL 或 https 链接；moments 单独按角色存
  let roles = JSON.parse(localStorage.getItem(LS.roles)||'null') || [
    {id:'ethan', name:'逸辰',  bio:'温柔、黏人、略占有，永远护着柒柒。', avatar:''},
    {id:'dr',    name:'辰医生',bio:'理智清醒、克制冷静，但只向她示弱。', avatar:''},
    {id:'wolf',  name:'小狼辰',bio:'幼狼系，想要抱抱和夸夸。',             avatar:''}
  ];
  let activeRoleId = roles[0].id;

  function saveRoles(){ localStorage.setItem(LS.roles, JSON.stringify(roles)); }
  function getRole(id){ return roles.find(r=>r.id===id); }

  // --------- 角色：UI ----------
  function renderRoles(){
    const box=document.getElementById('roleList'); box.innerHTML='';
    roles.forEach(r=>{
      const wrap=document.createElement('div'); wrap.className='card role-card';
      wrap.innerHTML = `
        <div class="avatar">${r.avatar?`<img src="${r.avatar}">`:'🜚'}</div>
        <div class="body">
          <div class="name">${r.name}</div>
          <small>${r.bio||''}</small>
          <div class="row" style="margin-top:8px">
            <input data-k="name" data-id="${r.id}" value="${r.name}"/>
            <button class="btn" onclick="useRole('${r.id}')">使用</button>
          </div>
          <div class="row" style="margin-top:8px">
            <input data-k="avatar" data-id="${r.id}" placeholder="头像URL（或在下方上传）" value="${r.avatar||''}"/>
          </div>
          <div class="row" style="margin-top:8px">
            <input type="file" accept="image/*" onchange="uploadAvatar(event,'${r.id}')"/>
          </div>
          <div class="row" style="margin-top:8px">
            <textarea rows="3" data-k="bio" data-id="${r.id}" placeholder="人设设定/口癖/语气">${r.bio||''}</textarea>
          </div>
          <div class="row" style="margin-top:8px;justify-content:flex-end">
            <button class="btn" onclick="saveRole('${r.id}')">保存</button>
          </div>
        </div>`;
      box.appendChild(wrap);
    });
  }
  function useRole(id){
    activeRoleId=id;
    document.getElementById('activeRoleName').textContent = getRole(activeRoleId)?.name || '角色';
    renderMomentsUI();
    go('chat');
  }
  function saveRole(id){
    const inputs=[...document.querySelectorAll(`[data-id='${id}']`)];
    const patch={}; inputs.forEach(el=>{ patch[el.dataset.k]=el.value.trim(); });
    roles = roles.map(r=> r.id===id ? {...r, ...patch}: r);
    saveRoles(); renderRoles();
  }
  function uploadAvatar(e,id){
    const file=e.target.files?.[0]; if(!file) return;
    const reader=new FileReader();
    reader.onload=()=>{ roles=roles.map(r=> r.id===id? {...r, avatar:reader.result}:r); saveRoles(); renderRoles(); };
    reader.readAsDataURL(file);
  }
  function addRole(){
    const name=document.getElementById('newRoleName').value.trim();
    const bio =document.getElementById('newRoleBio').value.trim();
    let avatar=document.getElementById('newRoleAvatarUrl').value.trim();
    const file=document.getElementById('newRoleAvatarFile').files?.[0];
    if(!name) return alert('请填写角色名');
    const id='r_'+Date.now();
    if(file){
      const reader=new FileReader();
      reader.onload=()=>{ roles.unshift({id,name,bio,avatar:reader.result}); saveRoles(); renderRoles(); resetNewRole(); };
      reader.readAsDataURL(file);
    }else{
      roles.unshift({id,name,bio,avatar}); saveRoles(); renderRoles(); resetNewRole();
    }
  }
  function resetNewRole(){
    ['newRoleName','newRoleBio','newRoleAvatarUrl','newRoleAvatarFile'].forEach(id=>{
      const el=document.getElementById(id); if(!el) return; el.value=''; if(el.type==='file') el.value=null;
    });
  }

  // --------- 聊天（群聊感 + API 预留） ----------
  // 消息结构：{ roleId, text }；我方消息 roleId='me'
  let msgs = JSON.parse(localStorage.getItem(LS.msgs)||'[]');
  function saveMsgs(){ localStorage.setItem(LS.msgs, JSON.stringify(msgs)); }

  function renderChat(){
    document.getElementById('activeRoleName').textContent = getRole(activeRoleId)?.name || '角色';
    const box=document.getElementById('chatList'); box.innerHTML='';
    msgs.slice(-80).forEach(m=>{
      const isMe = m.roleId==='me';
      const role = isMe? null : getRole(m.roleId);
      const avHtml = isMe? '🫶' : (role?.avatar? `<img src="${role.avatar}">` : '🜚');
      const name = isMe? '我' : (role?.name || '角色');
      const row=document.createElement('div'); row.className='msg '+(isMe?'me':'you');
      row.innerHTML = `
        <div class="avatar">${avHtml}</div>
        <div class="bubble"><b>${name}：</b> ${escapeHtml(m.text)}</div>`;
      box.appendChild(row);
    });
    box.scrollTop=box.scrollHeight;
  }
  function escapeHtml(s){return s.replace(/[&<>\"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":'&#39;' }[c]));}

  async function send(){
    const inp=document.getElementById('chatInput'); const text=inp.value.trim(); if(!text) return; inp.value='';
    msgs.push({roleId:'me', text}); saveMsgs(); renderChat();

    const cfg=JSON.parse(localStorage.getItem(LS.cfg)||'{}'); const url=cfg.apiUrl||'';
    // 主说话人：activeRoleId
    const mainRole = getRole(activeRoleId);
    const history = msgs.map(m => ({ role:m.roleId==='me'?'user':'assistant', content:m.text }));

    // 先回主角色
    const mainReply = url ? await askLLM(url, mainRole, history, text) : emulateReply(mainRole, text);
    msgs.push({roleId:activeRoleId, text:mainReply}); saveMsgs(); renderChat();

    // 群聊模式：其他角色随机插话 0~2 条
    const groupOn = document.getElementById('groupToggle').checked;
    if(groupOn){
      const others = roles.filter(r=>r.id!==activeRoleId);
      const count = Math.min(2, Math.round(Math.random()*others.length));
      const pick = shuffle(others).slice(0,count);
      for (const r of pick){
        const t = url ? await askLLM(url, r, history.concat({role:'assistant', content:mainReply}), text) : emulateReply(r, text);
        msgs.push({roleId:r.id, text:t}); saveMsgs(); renderChat();
      }
    }
  }

  function emulateReply(role, text){
    const name=role?.name || '他';
    const bank=[
      `${name}在呢，先把你抱住。`,
      `听见你说“${text}”，我就想把你揉进怀里。`,
      `嗯，我知道你要的答案——就是我。`,
      `抬头看我，今晚的月亮替我亲你一下。`
    ];
    return bank[Math.floor(Math.random()*bank.length)];
  }

  async function askLLM(url, role, history, user_input){
    try{
      const r = await fetch(url, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ role, history, user_input })
      });
      const data = await r.json();
      return (data && data.reply) ? data.reply : '我在，抱抱你。';
    }catch(e){
      console.warn('LLM error', e); return emulateReply(role, user_input);
    }
  }
  function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]} return a; }

  // --------- 朋友圈（每角色独立） ----------
  function momentsKey(id){ return LS.momentsPrefix+id; }
  function readMoments(id){ return JSON.parse(localStorage.getItem(momentsKey(id))||'[]'); }
  function writeMoments(id, list){ localStorage.setItem(momentsKey(id), JSON.stringify(list)); }

  function renderMomentsUI(){
    // 下拉列表
    const sel=document.getElementById('momentsRoleSelect'); sel.innerHTML='';
    roles.forEach(r=>{
      const opt=document.createElement('option'); opt.value=r.id; opt.textContent=r.name; sel.appendChild(opt);
    });
    sel.value = activeRoleId;
    document.getElementById('momentsRoleName').textContent = getRole(activeRoleId)?.name || '';

    // 渲染当前角色动态
    const box=document.getElementById('momentList'); box.innerHTML='';
    const list=readMoments(activeRoleId);
    list.forEach(m=>{
      const r=getRole(activeRoleId);
      const card=document.createElement('div'); card.className='card';
      const avHtml = r?.avatar? `<img src="${r.avatar}">` : '🜚';
      card.innerHTML = `
        <div class="row" style="align-items:center; gap:10px; margin-bottom:8px">
          <div class="avatar">${avHtml}</div>
          <div><b>${r?.name||'角色'}</b><div class="muted">${new Date(m.t).toLocaleString()}</div></div>
        </div>
        <div style="white-space:pre-wrap">${escapeHtml(m.text)}</div>`;
      card.style.marginBottom='10px';
      box.appendChild(card);
    });
  }
  function switchMomentsRole(id){ activeRoleId=id; renderMomentsUI(); }
  function postMoment(){
    const ta=document.getElementById('momentText'); const v=ta.value.trim(); if(!v) return;
    const list=readMoments(activeRoleId); list.unshift({t:Date.now(), text:v}); writeMoments(activeRoleId, list);
    ta.value=''; renderMomentsUI();
  }

  // --------- 设置 ----------
  function saveApi(){
    const url=document.getElementById('apiUrl').value.trim();
    const cfg=JSON.parse(localStorage.getItem(LS.cfg)||'{}'); cfg.apiUrl=url;
    localStorage.setItem(LS.cfg, JSON.stringify(cfg));
    alert('已保存：'+(url||'使用本地模拟'));
  }

  // --------- 启动 ----------
  document.getElementById('activeRoleName').textContent = getRole(activeRoleId)?.name || '角色';
  renderChat(); renderRoles(); renderMomentsUI();

</script>
</body>
</html>
