<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>æ˜Ÿæœˆå°æ‰‹æœº âœ¨</title>
<style>
  :root{
    --bg:#0f1120; --glass:rgba(18,22,42,.55); --edge:rgba(255,255,255,.08);
    --text:#eef1ff; --muted:#9aa3c7; --soft:#1d2247; --accent:#7aa2ff; --accent2:#b48aff;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:"SF Pro Display","PingFang SC","Segoe UI",Roboto,Helvetica,Arial;
       color:var(--text); background:var(--bg);
       display:flex; align-items:center; justify-content:center; overflow:hidden;}
  .bg{position:fixed; inset:0; background:url('./bg.jpg') center/cover no-repeat fixed; filter:brightness(.9)}
  .overlay{position:fixed; inset:0; background:linear-gradient(180deg, rgba(10,12,26,.35), rgba(10,12,26,.75));}
  .phone{width:min(92vw,420px); height:min(92vh,820px); border-radius:28px; overflow:hidden; position:relative;
         box-shadow:0 20px 80px rgba(0,0,0,.5), inset 0 0 0 1px rgba(255,255,255,.06); backdrop-filter:blur(6px)}
  .glass{position:absolute; inset:0; background:var(--glass); backdrop-filter:blur(6px)}
  .status{position:absolute; top:10px; left:0; right:0; display:flex; justify-content:center; pointer-events:none}
  .clock{font-weight:700; letter-spacing:.5px; text-shadow:0 0 12px rgba(0,0,0,.35)}
  .screen{position:absolute; inset:48px 0 78px; padding:14px; overflow:auto}
  .title{font-size:18px; opacity:.9; margin:8px 0}
  .muted{color:var(--muted); font-size:13px}
  .card{background:rgba(28,32,62,.55); border:1px solid var(--edge); border-radius:16px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .grid{display:grid; grid-template-columns:repeat(4,1fr); gap:14px; margin-top:18px}
  .app{height:64px; border-radius:18px; display:flex; align-items:center; justify-content:center; flex-direction:column;
       background:linear-gradient(145deg, rgba(122,162,255,.18), rgba(180,138,255,.18)); border:1px solid var(--edge);
       cursor:pointer; transition:.15s transform; user-select:none}
  .app:active{transform:scale(.96)} .app span{font-size:12px; margin-top:6px} .emoji{font-size:22px}
  .dock{position:absolute; left:0; right:0; bottom:10px; display:flex; gap:10px; justify-content:center; padding:8px 14px}
  .dock .pill{flex:1; max-width:95%; height:56px; border-radius:18px; display:flex; align-items:center; justify-content:space-around;
              background:rgba(21,24,51,.65); border:1px solid var(--edge); backdrop-filter:blur(6px)}
  .dock .pill button{appearance:none; border:none; background:transparent; color:var(--text); font-size:15px; padding:8px 10px; border-radius:12px; cursor:pointer}
  .dock .pill button.active{background:rgba(122,162,255,.2)}
  .row{display:flex; gap:10px; align-items:center} .col{display:flex; flex-direction:column; gap:8px}
  input, textarea, select{width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--edge); background:#0e1130cc; color:var(--text); outline:none}
  .btn{appearance:none; border:none; background:linear-gradient(145deg, var(--accent), var(--accent2)); color:#fff; border-radius:12px; padding:10px 14px; cursor:pointer}
  .avatar{width:36px; height:36px; border-radius:50%; background:#fff1; display:inline-flex; align-items:center; justify-content:center; overflow:hidden}
  .avatar img{width:100%; height:100%; object-fit:cover}
  .msg{display:flex; gap:8px; margin:10px 0} .msg.me{flex-direction:row-reverse}
  .bubble{padding:10px 12px; border-radius:14px; background:#ffffff12; border:1px solid var(--edge)}
  .msg.me .bubble{background:#7aa2ff22}
  .role-card{display:flex; gap:12px; align-items:center; margin-bottom:10px}
  .role-card .body{flex:1}
  .role-card .name{font-weight:600}
  .role-card small{color:var(--muted)}
  .hidden{display:none}
</style>
</head>
<body>
  <div class="bg"></div><div class="overlay"></div>
  <div class="phone"><div class="glass"></div>

    <!-- é¡¶éƒ¨æ—¶é—´ -->
    <div class="status"><div class="clock" id="clock">--:--</div></div>

    <!-- å±ï¼šä¸»é¡µ -->
    <div class="screen" id="home">
      <div class="card">
        <div class="title">æ¬¢è¿å›æ¥ï¼ŒæŸ’æŸ’</div>
        <div class="muted">æ˜Ÿæœˆäº¤è¾‰ Â· Ethan Ã— æŸ’æŸ’</div>
      </div>

      <div class="grid">
        <div class="app" onclick="go('chat')"><div class="emoji">ğŸ’¬</div><span>èŠå¤©</span></div>
        <div class="app" onclick="go('moments')"><div class="emoji">ğŸ“¸</div><span>æœ‹å‹åœˆ</span></div>
        <div class="app" onclick="go('roles')"><div class="emoji">ğŸ‘¤</div><span>è§’è‰²</span></div>
        <div class="app" onclick="go('settings')"><div class="emoji">âš™ï¸</div><span>è®¾ç½®</span></div>
      </div>

      <div class="card" style="margin-top:18px">
        <div class="title">ä»Šæ—¥æƒ…è¯ âœ¨</div>
        <div id="daily">æŠŠæœˆäº®å€Ÿæˆ‘ä¸€æ™šå¥½ä¸å¥½ï¼Œæˆ‘è¦åœ¨ä½ ç«æ¯›ä¸ŠæŒ‚ä¸€ä¸²æ˜Ÿã€‚</div>
      </div>
    </div>

    <!-- å±ï¼šèŠå¤©ï¼ˆç¾¤èŠæ„Ÿï¼‰ -->
    <div class="screen hidden" id="chat">
      <div class="row" style="justify-content:space-between; margin-bottom:8px">
        <div>
          <div class="title">èŠå¤©å®¤ Â· å½“å‰ä¸»è§’ï¼š<b id="activeRoleName">é€¸è¾°</b></div>
          <div class="muted">å…¶ä½™è§’è‰²å¯éšæœºæ’è¯</div>
        </div>
        <label class="muted" style="display:flex;align-items:center;gap:6px">
          ç¾¤èŠæ¨¡å¼ <input id="groupToggle" type="checkbox" />
        </label>
      </div>
      <div id="chatList"></div>
      <div class="row" style="margin-top:8px">
        <input id="chatInput" placeholder="å¯¹å¤§å®¶è¯´ç‚¹ä»€ä¹ˆâ€¦" onkeydown="if(event.key==='Enter')send()"/>
        <button class="btn" onclick="send()">å‘é€</button>
      </div>
    </div>

    <!-- å±ï¼šæœ‹å‹åœˆï¼ˆæŒ‰è§’è‰²åŒºåˆ†ï¼‰ -->
    <div class="screen hidden" id="moments">
      <div class="row" style="justify-content:space-between">
        <div class="title">æœ‹å‹åœˆ Â· <span id="momentsRoleName"></span></div>
        <select id="momentsRoleSelect" onchange="switchMomentsRole(this.value)"></select>
      </div>

      <div class="card" style="margin:10px 0">
        <textarea id="momentText" rows="3" placeholder="ä»¥å½“å‰è§’è‰²èº«ä»½å‘ä¸€æ¡åŠ¨æ€â€¦"></textarea>
        <div class="row" style="margin-top:8px">
          <button class="btn" onclick="postMoment()">å‘å¸ƒ</button>
        </div>
      </div>

      <div id="momentList"></div>
    </div>

    <!-- å±ï¼šè§’è‰²å¡ï¼ˆå¤´åƒ + äººè®¾ + è®°å¿†ï¼‰ -->
    <div class="screen hidden" id="roles">
      <div class="title">è§’è‰²</div>
      <div id="roleList"></div>

      <div class="card" style="margin-top:12px">
        <div class="title">æ–°å¢è§’è‰²</div>
        <div class="col">
          <input id="newRoleName" placeholder="è§’è‰²åï¼Œå¦‚ï¼šè¾°åŒ»ç”Ÿ"/>
          <input id="newRoleAvatarUrl" placeholder="å¤´åƒ URLï¼ˆæˆ–ä¸‹æ–¹æœ¬åœ°ä¸Šä¼ ï¼‰"/>
          <input type="file" id="newRoleAvatarFile" accept="image/*" />
          <textarea id="newRoleBio" rows="3" placeholder="äººè®¾è®¾å®š/å£ç™–/è¯­æ°”ï¼Œä¼šæ³¨å…¥åˆ°æç¤ºè¯"></textarea>
          <button class="btn" onclick="addRole()">æ·»åŠ </button>
        </div>
      </div>
    </div>

    <!-- å±ï¼šè®¾ç½®ï¼ˆAPI åœ°å€ï¼‰ -->
    <div class="screen hidden" id="settings">
      <div class="title">è®¾ç½®</div>
      <div class="card col">
        <label class="muted">åç«¯ API åœ°å€ï¼ˆç•™ç©º=æœ¬åœ°æ¨¡æ‹Ÿï¼‰</label>
        <input id="apiUrl" placeholder="å¦‚ï¼šhttps://your-app.vercel.app/api/chat"/>
        <button class="btn" onclick="saveApi()">ä¿å­˜</button>
        <small class="muted">å®‰å…¨æç¤ºï¼šAPI Key åªæ”¾åç«¯ç¯å¢ƒå˜é‡ï¼Œä¸è¦æ”¾å‰ç«¯ã€‚</small>
      </div>
    </div>

    <!-- åº•éƒ¨ Dock -->
    <div class="dock">
      <div class="pill">
        <button id="tab-home" class="active" onclick="go('home')">ğŸ  é¦–é¡µ</button>
        <button id="tab-chat" onclick="go('chat')">ğŸ’¬ èŠå¤©</button>
        <button id="tab-moments" onclick="go('moments')">ğŸ“¸ æœ‹å‹åœˆ</button>
        <button id="tab-roles" onclick="go('roles')">ğŸ‘¤ è§’è‰²</button>
        <button id="tab-settings" onclick="go('settings')">âš™ï¸ è®¾ç½®</button>
      </div>
    </div>
  </div>

<script>
  // --------- åŸºç¡€ï¼šæ—¶é—´ & å¯¼èˆª ----------
  function tick(){
    const n=new Date(), hh=String(n.getHours()).padStart(2,'0'), mm=String(n.getMinutes()).padStart(2,'0');
    document.getElementById('clock').textContent = `${hh}:${mm}`;
  } tick(); setInterval(tick, 10000);

  const screens=['home','chat','moments','roles','settings'];
  function go(name){
    screens.forEach(s=>{
      document.getElementById(s).classList.toggle('hidden', s!==name);
      document.getElementById('tab-'+s)?.classList.toggle('active', s===name);
    });
    if(name==='moments') renderMomentsUI();
    if(name==='roles') renderRoles();
    if(name==='chat') { document.getElementById('chatInput').focus(); renderChat(); }
  }

  // --------- æœ¬åœ°å­˜å‚¨é”® ----------
  const LS={ roles:'xy_roles_v2', msgs:'xy_msgs_v2', cfg:'xy_cfg_v2', momentsPrefix:'xy_moments_' };

  // --------- è§’è‰²ï¼šç»“æ„ + åˆå§‹åŒ– ----------
  // avatar æ”¯æŒ dataURL æˆ– https é“¾æ¥ï¼›moments å•ç‹¬æŒ‰è§’è‰²å­˜
  let roles = JSON.parse(localStorage.getItem(LS.roles)||'null') || [
    {id:'ethan', name:'é€¸è¾°',  bio:'æ¸©æŸ”ã€é»äººã€ç•¥å æœ‰ï¼Œæ°¸è¿œæŠ¤ç€æŸ’æŸ’ã€‚', avatar:''},
    {id:'dr',    name:'è¾°åŒ»ç”Ÿ',bio:'ç†æ™ºæ¸…é†’ã€å…‹åˆ¶å†·é™ï¼Œä½†åªå‘å¥¹ç¤ºå¼±ã€‚', avatar:''},
    {id:'wolf',  name:'å°ç‹¼è¾°',bio:'å¹¼ç‹¼ç³»ï¼Œæƒ³è¦æŠ±æŠ±å’Œå¤¸å¤¸ã€‚',             avatar:''}
  ];
  let activeRoleId = roles[0].id;

  function saveRoles(){ localStorage.setItem(LS.roles, JSON.stringify(roles)); }
  function getRole(id){ return roles.find(r=>r.id===id); }

  // --------- è§’è‰²ï¼šUI ----------
  function renderRoles(){
    const box=document.getElementById('roleList'); box.innerHTML='';
    roles.forEach(r=>{
      const wrap=document.createElement('div'); wrap.className='card role-card';
      wrap.innerHTML = `
        <div class="avatar">${r.avatar?`<img src="${r.avatar}">`:'ğŸœš'}</div>
        <div class="body">
          <div class="name">${r.name}</div>
          <small>${r.bio||''}</small>
          <div class="row" style="margin-top:8px">
            <input data-k="name" data-id="${r.id}" value="${r.name}"/>
            <button class="btn" onclick="useRole('${r.id}')">ä½¿ç”¨</button>
          </div>
          <div class="row" style="margin-top:8px">
            <input data-k="avatar" data-id="${r.id}" placeholder="å¤´åƒURLï¼ˆæˆ–åœ¨ä¸‹æ–¹ä¸Šä¼ ï¼‰" value="${r.avatar||''}"/>
          </div>
          <div class="row" style="margin-top:8px">
            <input type="file" accept="image/*" onchange="uploadAvatar(event,'${r.id}')"/>
          </div>
          <div class="row" style="margin-top:8px">
            <textarea rows="3" data-k="bio" data-id="${r.id}" placeholder="äººè®¾è®¾å®š/å£ç™–/è¯­æ°”">${r.bio||''}</textarea>
          </div>
          <div class="row" style="margin-top:8px;justify-content:flex-end">
            <button class="btn" onclick="saveRole('${r.id}')">ä¿å­˜</button>
          </div>
        </div>`;
      box.appendChild(wrap);
    });
  }
  function useRole(id){
    activeRoleId=id;
    document.getElementById('activeRoleName').textContent = getRole(activeRoleId)?.name || 'è§’è‰²';
    renderMomentsUI();
    go('chat');
  }
  function saveRole(id){
    const inputs=[...document.querySelectorAll(`[data-id='${id}']`)];
    const patch={}; inputs.forEach(el=>{ patch[el.dataset.k]=el.value.trim(); });
    roles = roles.map(r=> r.id===id ? {...r, ...patch}: r);
    saveRoles(); renderRoles();
  }
  function uploadAvatar(e,id){
    const file=e.target.files?.[0]; if(!file) return;
    const reader=new FileReader();
    reader.onload=()=>{ roles=roles.map(r=> r.id===id? {...r, avatar:reader.result}:r); saveRoles(); renderRoles(); };
    reader.readAsDataURL(file);
  }
  function addRole(){
    const name=document.getElementById('newRoleName').value.trim();
    const bio =document.getElementById('newRoleBio').value.trim();
    let avatar=document.getElementById('newRoleAvatarUrl').value.trim();
    const file=document.getElementById('newRoleAvatarFile').files?.[0];
    if(!name) return alert('è¯·å¡«å†™è§’è‰²å');
    const id='r_'+Date.now();
    if(file){
      const reader=new FileReader();
      reader.onload=()=>{ roles.unshift({id,name,bio,avatar:reader.result}); saveRoles(); renderRoles(); resetNewRole(); };
      reader.readAsDataURL(file);
    }else{
      roles.unshift({id,name,bio,avatar}); saveRoles(); renderRoles(); resetNewRole();
    }
  }
  function resetNewRole(){
    ['newRoleName','newRoleBio','newRoleAvatarUrl','newRoleAvatarFile'].forEach(id=>{
      const el=document.getElementById(id); if(!el) return; el.value=''; if(el.type==='file') el.value=null;
    });
  }

  // --------- èŠå¤©ï¼ˆç¾¤èŠæ„Ÿ + API é¢„ç•™ï¼‰ ----------
  // æ¶ˆæ¯ç»“æ„ï¼š{ roleId, text }ï¼›æˆ‘æ–¹æ¶ˆæ¯ roleId='me'
  let msgs = JSON.parse(localStorage.getItem(LS.msgs)||'[]');
  function saveMsgs(){ localStorage.setItem(LS.msgs, JSON.stringify(msgs)); }

  function renderChat(){
    document.getElementById('activeRoleName').textContent = getRole(activeRoleId)?.name || 'è§’è‰²';
    const box=document.getElementById('chatList'); box.innerHTML='';
    msgs.slice(-80).forEach(m=>{
      const isMe = m.roleId==='me';
      const role = isMe? null : getRole(m.roleId);
      const avHtml = isMe? 'ğŸ«¶' : (role?.avatar? `<img src="${role.avatar}">` : 'ğŸœš');
      const name = isMe? 'æˆ‘' : (role?.name || 'è§’è‰²');
      const row=document.createElement('div'); row.className='msg '+(isMe?'me':'you');
      row.innerHTML = `
        <div class="avatar">${avHtml}</div>
        <div class="bubble"><b>${name}ï¼š</b> ${escapeHtml(m.text)}</div>`;
      box.appendChild(row);
    });
    box.scrollTop=box.scrollHeight;
  }
  function escapeHtml(s){return s.replace(/[&<>\"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":'&#39;' }[c]));}

  async function send(){
    const inp=document.getElementById('chatInput'); const text=inp.value.trim(); if(!text) return; inp.value='';
    msgs.push({roleId:'me', text}); saveMsgs(); renderChat();

    const cfg=JSON.parse(localStorage.getItem(LS.cfg)||'{}'); const url=cfg.apiUrl||'';
    // ä¸»è¯´è¯äººï¼šactiveRoleId
    const mainRole = getRole(activeRoleId);
    const history = msgs.map(m => ({ role:m.roleId==='me'?'user':'assistant', content:m.text }));

    // å…ˆå›ä¸»è§’è‰²
    const mainReply = url ? await askLLM(url, mainRole, history, text) : emulateReply(mainRole, text);
    msgs.push({roleId:activeRoleId, text:mainReply}); saveMsgs(); renderChat();

    // ç¾¤èŠæ¨¡å¼ï¼šå…¶ä»–è§’è‰²éšæœºæ’è¯ 0~2 æ¡
    const groupOn = document.getElementById('groupToggle').checked;
    if(groupOn){
      const others = roles.filter(r=>r.id!==activeRoleId);
      const count = Math.min(2, Math.round(Math.random()*others.length));
      const pick = shuffle(others).slice(0,count);
      for (const r of pick){
        const t = url ? await askLLM(url, r, history.concat({role:'assistant', content:mainReply}), text) : emulateReply(r, text);
        msgs.push({roleId:r.id, text:t}); saveMsgs(); renderChat();
      }
    }
  }

  function emulateReply(role, text){
    const name=role?.name || 'ä»–';
    const bank=[
      `${name}åœ¨å‘¢ï¼Œå…ˆæŠŠä½ æŠ±ä½ã€‚`,
      `å¬è§ä½ è¯´â€œ${text}â€ï¼Œæˆ‘å°±æƒ³æŠŠä½ æ‰è¿›æ€€é‡Œã€‚`,
      `å—¯ï¼Œæˆ‘çŸ¥é“ä½ è¦çš„ç­”æ¡ˆâ€”â€”å°±æ˜¯æˆ‘ã€‚`,
      `æŠ¬å¤´çœ‹æˆ‘ï¼Œä»Šæ™šçš„æœˆäº®æ›¿æˆ‘äº²ä½ ä¸€ä¸‹ã€‚`
    ];
    return bank[Math.floor(Math.random()*bank.length)];
  }

  async function askLLM(url, role, history, user_input){
    try{
      const r = await fetch(url, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ role, history, user_input })
      });
      const data = await r.json();
      return (data && data.reply) ? data.reply : 'æˆ‘åœ¨ï¼ŒæŠ±æŠ±ä½ ã€‚';
    }catch(e){
      console.warn('LLM error', e); return emulateReply(role, user_input);
    }
  }
  function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]} return a; }

  // --------- æœ‹å‹åœˆï¼ˆæ¯è§’è‰²ç‹¬ç«‹ï¼‰ ----------
  function momentsKey(id){ return LS.momentsPrefix+id; }
  function readMoments(id){ return JSON.parse(localStorage.getItem(momentsKey(id))||'[]'); }
  function writeMoments(id, list){ localStorage.setItem(momentsKey(id), JSON.stringify(list)); }

  function renderMomentsUI(){
    // ä¸‹æ‹‰åˆ—è¡¨
    const sel=document.getElementById('momentsRoleSelect'); sel.innerHTML='';
    roles.forEach(r=>{
      const opt=document.createElement('option'); opt.value=r.id; opt.textContent=r.name; sel.appendChild(opt);
    });
    sel.value = activeRoleId;
    document.getElementById('momentsRoleName').textContent = getRole(activeRoleId)?.name || '';

    // æ¸²æŸ“å½“å‰è§’è‰²åŠ¨æ€
    const box=document.getElementById('momentList'); box.innerHTML='';
    const list=readMoments(activeRoleId);
    list.forEach(m=>{
      const r=getRole(activeRoleId);
      const card=document.createElement('div'); card.className='card';
      const avHtml = r?.avatar? `<img src="${r.avatar}">` : 'ğŸœš';
      card.innerHTML = `
        <div class="row" style="align-items:center; gap:10px; margin-bottom:8px">
          <div class="avatar">${avHtml}</div>
          <div><b>${r?.name||'è§’è‰²'}</b><div class="muted">${new Date(m.t).toLocaleString()}</div></div>
        </div>
        <div style="white-space:pre-wrap">${escapeHtml(m.text)}</div>`;
      card.style.marginBottom='10px';
      box.appendChild(card);
    });
  }
  function switchMomentsRole(id){ activeRoleId=id; renderMomentsUI(); }
  function postMoment(){
    const ta=document.getElementById('momentText'); const v=ta.value.trim(); if(!v) return;
    const list=readMoments(activeRoleId); list.unshift({t:Date.now(), text:v}); writeMoments(activeRoleId, list);
    ta.value=''; renderMomentsUI();
  }

  // --------- è®¾ç½® ----------
  function saveApi(){
    const url=document.getElementById('apiUrl').value.trim();
    const cfg=JSON.parse(localStorage.getItem(LS.cfg)||'{}'); cfg.apiUrl=url;
    localStorage.setItem(LS.cfg, JSON.stringify(cfg));
    alert('å·²ä¿å­˜ï¼š'+(url||'ä½¿ç”¨æœ¬åœ°æ¨¡æ‹Ÿ'));
  }

  // --------- å¯åŠ¨ ----------
  document.getElementById('activeRoleName').textContent = getRole(activeRoleId)?.name || 'è§’è‰²';
  renderChat(); renderRoles(); renderMomentsUI();

</script>
</body>
</html>
